more functions and nested loops

Lord, give us a break out of endless loops
